name: Automated Claude Development Workflow

on:
  repository_dispatch:
    types: [jira_task_created, jira_task_updated]
  workflow_dispatch:
    inputs:
      jira_number:
        description: 'Manual trigger - Jira ticket number (e.g., LDOC-123)'
        required: true
        type: string

env:
  JIRA_NUMBER: ${{ github.event.client_payload.jira_number || github.event.inputs.jira_number }}

jobs:
  # Phase 1: Issue Creation and Requirements Analysis
  phase1-requirements:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    outputs:
      issue_number: ${{ steps.create_issue.outputs.issue_number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Phase 1 - Requirements Analysis
        id: requirements
        uses: anthropics/claude-code-base-action@beta
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JIRA_URL: https://hikky.atlassian.net
          JIRA_USERNAME: r.akai@vrhikky.com
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          prompt: |
            ã€ãƒ•ã‚§ãƒ¼ã‚º1: è¦ä»¶åˆ†æžã¨GitHub Issueä½œæˆã€‘
            
            Jiraç•ªå· '${{ env.JIRA_NUMBER }}' ã«ã¤ã„ã¦ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
            
            1. MCPã®Jiraæ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã‚¿ã‚¹ã‚¯è©³ç´°ã‚’å–å¾—
            2. è¦ä»¶ã‚’åˆ†æžã—ã€æŠ€è¡“çš„ãªå®Ÿè£…æ–¹é‡ã‚’ç­–å®š
            3. GitHub Issueã‚’ä½œæˆï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã«@claudeã‚’è¿½åŠ ï¼‰
            4. Issueã®å†…å®¹ã«ä»¥ä¸‹ã®å®Ÿè¡Œè¨ˆç”»ã‚’è¨˜è¼‰ï¼š
               - A. è¦ä»¶å®šç¾©ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ âœ“
               - B. è¨­è¨ˆæ›¸ã‚’ä½œæˆ (æ¬¡ãƒ•ã‚§ãƒ¼ã‚º)
               - C. TDDã§ã‚³ãƒ¼ãƒ‰å®Ÿè£… (æ¬¡ãƒ•ã‚§ãƒ¼ã‚º)
               - D. Pull Requestã‚’ä½œæˆ (æ¬¡ãƒ•ã‚§ãƒ¼ã‚º)
            5. issue.txtãƒ•ã‚¡ã‚¤ãƒ«ã«ä½œæˆã—ãŸIssueç•ªå·ã‚’å‡ºåŠ›
            
            æ³¨æ„ï¼šMCPãƒ„ãƒ¼ãƒ«ã®ä½¿ç”¨è¨±å¯ãŒæ±‚ã‚ã‚‰ã‚ŒãŸå ´åˆã¯ã€å‡¦ç†ã‚’çµ‚ãˆã¦ãã ã•ã„ã€‚
          mcp_config: ".mcp.json"
          allowed_tools: "Bash,View,GlobTool,GrepTool,BatchTool,Edit,Write,mcp__mcp-atlassian__jira_get_user_profile,mcp__mcp-atlassian__jira_get_issue,mcp__mcp-atlassian__jira_search,mcp__mcp-atlassian__jira_search_fields,mcp__mcp-atlassian__jira_get_project_issues,mcp__mcp-atlassian__jira_get_transitions,mcp__mcp-atlassian__jira_get_worklog,mcp__mcp-atlassian__jira_download_attachments,mcp__mcp-atlassian__jira_get_agile_boards,mcp__mcp-atlassian__jira_get_board_issues,mcp__mcp-atlassian__jira_get_sprints_from_board,mcp__mcp-atlassian__jira_get_sprint_issues,mcp__mcp-atlassian__jira_get_link_types,mcp__mcp-atlassian__jira_create_issue,mcp__mcp-atlassian__jira_batch_create_issues,mcp__mcp-atlassian__jira_batch_get_changelogs,mcp__mcp-atlassian__jira_update_issue,mcp__mcp-atlassian__jira_delete_issue,mcp__mcp-atlassian__jira_add_comment,mcp__mcp-atlassian__jira_add_worklog,mcp__mcp-atlassian__jira_link_to_epic,mcp__mcp-atlassian__jira_create_issue_link,mcp__mcp-atlassian__jira_remove_issue_link,mcp__mcp-atlassian__jira_transition_issue,mcp__mcp-atlassian__jira_create_sprint,mcp__mcp-atlassian__jira_update_sprint,mcp__mcp-atlassian__confluence_search,mcp__mcp-atlassian__confluence_get_page,mcp__mcp-atlassian__confluence_get_page_children,mcp__mcp-atlassian__confluence_get_comments,mcp__mcp-atlassian__confluence_get_labels,mcp__mcp-atlassian__confluence_add_label,mcp__mcp-atlassian__confluence_create_page,mcp__mcp-atlassian__confluence_update_page,mcp__mcp-atlassian__confluence_delete_page,mcp__mcp-atlassian__confluence_add_comment"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Extract Issue Number
        id: create_issue
        run: |
          if [ -f "issue.txt" ]; then
            echo "issue_number=$(cat issue.txt)" >> $GITHUB_OUTPUT
          else
            echo "issue_number=" >> $GITHUB_OUTPUT
          fi

  # Phase 2: Design and Implementation
  phase2-implementation:
    needs: phase1-requirements
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create feature branch
        run: |
          BRANCH_NAME="feature/jira-${{ env.JIRA_NUMBER }}-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Phase 2 - Design and Implementation
        uses: anthropics/claude-code-base-action@beta
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JIRA_URL: https://hikky.atlassian.net
          JIRA_USERNAME: r.akai@vrhikky.com
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          ISSUE_NUMBER: ${{ needs.phase1-requirements.outputs.issue_number }}
        with:
          prompt: |
            ã€ãƒ•ã‚§ãƒ¼ã‚º2: è¨­è¨ˆã¨TDDå®Ÿè£…ã€‘
            
            Jiraç•ªå· '${{ env.JIRA_NUMBER }}' ã®ã‚¿ã‚¹ã‚¯ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
            
            1. è©³ç´°è¨­è¨ˆæ›¸ã‚’ä½œæˆï¼ˆdocs/design/é…ä¸‹ã«é…ç½®ï¼‰
            2. TDD (Test Driven Development) ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§å®Ÿè£…
               - ã¾ãšãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ä½œæˆ
               - ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
               - æœ€å°é™ã®å®Ÿè£…ã§ãƒ†ã‚¹ãƒˆã‚’ãƒ‘ã‚¹
               - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
            3. ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
            4. å®Ÿè£…ãŒå®Œäº†ã—ãŸã‚‰GitHub Issue #${{ env.ISSUE_NUMBER }} ã‚’æ›´æ–°
            5. æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºç”¨ã«commit.txtãƒ•ã‚¡ã‚¤ãƒ«ã«æœ€æ–°ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã‚’å‡ºåŠ›
            
            ãƒ–ãƒ©ãƒ³ãƒå: ${{ env.BRANCH_NAME }}
            å®Ÿè£…ã¯æ®µéšŽçš„ã«ã‚³ãƒŸãƒƒãƒˆã—ã€å„æ®µéšŽã§æ„å‘³ã®ã‚ã‚‹ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚
          mcp_config: ".mcp.json"
          allowed_tools: "Bash,View,GlobTool,GrepTool,BatchTool,Edit,Write,mcp__mcp-atlassian__jira_get_user_profile,mcp__mcp-atlassian__jira_get_issue,mcp__mcp-atlassian__jira_search,mcp__mcp-atlassian__jira_search_fields,mcp__mcp-atlassian__jira_get_project_issues,mcp__mcp-atlassian__jira_get_transitions,mcp__mcp-atlassian__jira_get_worklog,mcp__mcp-atlassian__jira_download_attachments,mcp__mcp-atlassian__jira_get_agile_boards,mcp__mcp-atlassian__jira_get_board_issues,mcp__mcp-atlassian__jira_get_sprints_from_board,mcp__mcp-atlassian__jira_get_sprint_issues,mcp__mcp-atlassian__jira_get_link_types,mcp__mcp-atlassian__jira_create_issue,mcp__mcp-atlassian__jira_batch_create_issues,mcp__mcp-atlassian__jira_batch_get_changelogs,mcp__mcp-atlassian__jira_update_issue,mcp__mcp-atlassian__jira_delete_issue,mcp__mcp-atlassian__jira_add_comment,mcp__mcp-atlassian__jira_add_worklog,mcp__mcp-atlassian__jira_link_to_epic,mcp__mcp-atlassian__jira_create_issue_link,mcp__mcp-atlassian__jira_remove_issue_link,mcp__mcp-atlassian__jira_transition_issue,mcp__mcp-atlassian__jira_create_sprint,mcp__mcp-atlassian__jira_update_sprint,mcp__mcp-atlassian__confluence_search,mcp__mcp-atlassian__confluence_get_page,mcp__mcp-atlassian__confluence_get_page_children,mcp__mcp-atlassian__confluence_get_comments,mcp__mcp-atlassian__confluence_get_labels,mcp__mcp-atlassian__confluence_add_label,mcp__mcp-atlassian__confluence_create_page,mcp__mcp-atlassian__confluence_update_page,mcp__mcp-atlassian__confluence_delete_page,mcp__mcp-atlassian__confluence_add_comment"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Push feature branch
        run: |
          git push origin ${{ env.BRANCH_NAME }}

  # Phase 3: Pull Request Creation and Review
  phase3-pull-request:
    needs: [phase1-requirements, phase2-implementation]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Phase 3 - Pull Request Creation
        uses: anthropics/claude-code-base-action@beta
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JIRA_URL: https://hikky.atlassian.net
          JIRA_USERNAME: r.akai@vrhikky.com
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          ISSUE_NUMBER: ${{ needs.phase1-requirements.outputs.issue_number }}
        with:
          prompt: |
            ã€ãƒ•ã‚§ãƒ¼ã‚º3: Pull Requestä½œæˆã¨å®Œäº†ã€‘
            
            Jiraç•ªå· '${{ env.JIRA_NUMBER }}' ã®ã‚¿ã‚¹ã‚¯ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
            
            1. ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰mainãƒ–ãƒ©ãƒ³ãƒã¸ã®Pull Requestã‚’ä½œæˆ
            2. PRã®èª¬æ˜Žã«ä»¥ä¸‹ã‚’å«ã‚ã‚‹ï¼š
               - Jiraã‚¿ã‚¹ã‚¯ã¸ã®ãƒªãƒ³ã‚¯
               - å®Ÿè£…å†…å®¹ã®æ¦‚è¦
               - ãƒ†ã‚¹ãƒˆçµæžœ
               - ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ
               - ç ´å£Šçš„å¤‰æ›´ã®æœ‰ç„¡
            3. GitHub Issue #${{ env.ISSUE_NUMBER }} ã«PRãƒªãƒ³ã‚¯ã‚’è¿½åŠ 
            4. Jiraã‚¿ã‚¹ã‚¯ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆå®Ÿè£…å®Œäº†ã®å ±å‘Šï¼‰
            5. Jiraã‚¿ã‚¹ã‚¯ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’"Code Review"ã¾ãŸã¯é©åˆ‡ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¤‰æ›´
            6. pr.txtãƒ•ã‚¡ã‚¤ãƒ«ã«PRç•ªå·ã‚’å‡ºåŠ›
            
            æ³¨æ„ï¼š
            - PRã®ãƒžãƒ¼ã‚¸ã¯æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã«è¡Œã†
            - è‡ªå‹•ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèª
            - ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç¢ºèª
          mcp_config: ".mcp.json"
          allowed_tools: "Bash,View,GlobTool,GrepTool,BatchTool,Edit,Write,mcp__mcp-atlassian__jira_get_user_profile,mcp__mcp-atlassian__jira_get_issue,mcp__mcp-atlassian__jira_search,mcp__mcp-atlassian__jira_search_fields,mcp__mcp-atlassian__jira_get_project_issues,mcp__mcp-atlassian__jira_get_transitions,mcp__mcp-atlassian__jira_get_worklog,mcp__mcp-atlassian__jira_download_attachments,mcp__mcp-atlassian__jira_get_agile_boards,mcp__mcp-atlassian__jira_get_board_issues,mcp__mcp-atlassian__jira_get_sprints_from_board,mcp__mcp-atlassian__jira_get_sprint_issues,mcp__mcp-atlassian__jira_get_link_types,mcp__mcp-atlassian__jira_create_issue,mcp__mcp-atlassian__jira_batch_create_issues,mcp__mcp-atlassian__jira_batch_get_changelogs,mcp__mcp-atlassian__jira_update_issue,mcp__mcp-atlassian__jira_delete_issue,mcp__mcp-atlassian__jira_add_comment,mcp__mcp-atlassian__jira_add_worklog,mcp__mcp-atlassian__jira_link_to_epic,mcp__mcp-atlassian__jira_create_issue_link,mcp__mcp-atlassian__jira_remove_issue_link,mcp__mcp-atlassian__jira_transition_issue,mcp__mcp-atlassian__jira_create_sprint,mcp__mcp-atlassian__jira_update_sprint,mcp__mcp-atlassian__confluence_search,mcp__mcp-atlassian__confluence_get_page,mcp__mcp-atlassian__confluence_get_page_children,mcp__mcp-atlassian__confluence_get_comments,mcp__mcp-atlassian__confluence_get_labels,mcp__mcp-atlassian__confluence_add_label,mcp__mcp-atlassian__confluence_create_page,mcp__mcp-atlassian__confluence_update_page,mcp__mcp-atlassian__confluence_delete_page,mcp__mcp-atlassian__confluence_add_comment"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Workflow Summary
        run: |
          echo "## ðŸš€ è‡ªå‹•åŒ–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "Jiraç•ªå·: ${{ env.JIRA_NUMBER }}" >> $GITHUB_STEP_SUMMARY
          if [ -f "issue.txt" ]; then
            echo "GitHub Issue: #$(cat issue.txt)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f "pr.txt" ]; then
            echo "Pull Request: #$(cat pr.txt)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å®Ÿè¡Œã•ã‚ŒãŸãƒ•ã‚§ãƒ¼ã‚º" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ãƒ•ã‚§ãƒ¼ã‚º1: è¦ä»¶åˆ†æžã¨Issueä½œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ãƒ•ã‚§ãƒ¼ã‚º2: è¨­è¨ˆã¨TDDå®Ÿè£…" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ãƒ•ã‚§ãƒ¼ã‚º3: Pull Requestä½œæˆ" >> $GITHUB_STEP_SUMMARY